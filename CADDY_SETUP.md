# Gantry Caddy Setup & Certificate Management

Gantry uses **Caddy** as a reverse proxy to route traffic from `.test` domains to your local development projects. Caddy automatically handles HTTPS with self-signed certificates generated by **mkcert**, providing a seamless local development experience.

## Table of Contents

- [Caddy Setup Instructions](#caddy-setup-instructions)
- [Self-Signed Certificate Explanation](#self-signed-certificate-explanation)
- [How to Add Subservices (Adminer, MailHog)](#how-to-add-subservices-adminer-mailhog)
- [Troubleshooting Certificate Trust Issues](#troubleshooting-certificate-trust-issues)

---

## Caddy Setup Instructions

### What is Caddy?

Caddy is a powerful, enterprise-ready, open-source web server with automatic HTTPS. Gantry uses Caddy as a reverse proxy to route requests from domains like `myapp.test` to your local development servers running on various ports.

### Automatic Installation

Gantry can automatically download and install Caddy for you. Run:

```bash
gantry setup caddy
```

This command will:
1. Check if Caddy is already installed (either in `~/.gantry/bin/caddy` or system PATH)
2. Download the appropriate Caddy binary for your architecture (amd64 or arm64)
3. Install it to `~/.gantry/bin/caddy`
4. Set executable permissions

### Manual Installation

If you prefer to install Caddy manually:

1. **Using your system package manager:**
   ```bash
   # Debian/Ubuntu
   sudo apt install caddy
   
   # Arch/Manjaro
   sudo pacman -S caddy
   
   # Fedora
   sudo dnf install caddy
   ```

2. **Or download from GitHub:**
   - Visit [Caddy releases](https://github.com/caddyserver/caddy/releases)
   - Download the appropriate binary for your system
   - Place it in your PATH or in `~/.gantry/bin/caddy`

### Verifying Installation

Check if Caddy is installed:

```bash
gantry status
```

This will show the status of all dependencies, including Caddy.

### How Caddy Works with Gantry

1. **Configuration Generation**: When you register projects, Gantry automatically generates a `Caddyfile` at `~/.gantry/caddy/Caddyfile` with routing rules for all your projects.

2. **Automatic Routing**: Caddy listens on ports 80 (HTTP) and 443 (HTTPS) and routes requests based on the domain:
   - `myapp.test` → `localhost:5001` (your project's main port)
   - `postgres.myapp.test` → `localhost:5432` (PostgreSQL service)
   - `mailhog.myapp.test` → `localhost:8025` (MailHog web UI)

3. **HTTPS by Default**: Caddy automatically serves HTTPS using certificates generated by mkcert (see [Self-Signed Certificate Explanation](#self-signed-certificate-explanation)).

### Starting and Stopping Caddy

Gantry manages Caddy automatically:

- **Start Caddy**: Caddy starts automatically when you use commands that require it (e.g., `gantry start`)
- **Stop Caddy**: Use `gantry stop` or `gantry caddy stop`
- **Reload Configuration**: When you register/unregister projects, Gantry automatically reloads Caddy's configuration

### Viewing the Generated Caddyfile

You can inspect the generated Caddyfile:

```bash
cat ~/.gantry/caddy/Caddyfile
```

Example output:

```caddy
# Auto-generated by Gantry
{
  http_port 80
  https_port 443
}

# Project: myapp
myapp.test {
  reverse_proxy localhost:5001
}

postgres.myapp.test {
  reverse_proxy localhost:5432
}

mailhog.myapp.test {
  reverse_proxy localhost:8025
}
```

### Port Requirements

Caddy requires access to ports 80 and 443. If these ports are already in use:

1. **Check what's using the ports:**
   ```bash
   sudo lsof -i :80
   sudo lsof -i :443
   ```

2. **Stop conflicting services** (e.g., Apache, Nginx, or another Caddy instance)

3. **Or run Caddy on different ports** by editing `~/.gantry/caddy/Caddyfile` (not recommended, as browsers expect ports 80/443)

---

## Self-Signed Certificate Explanation

### Why Self-Signed Certificates?

For local development, you need HTTPS certificates that your browser will trust. Gantry uses **mkcert** to generate self-signed certificates that are automatically trusted by your system and browsers.

### What is mkcert?

**mkcert** is a simple tool for making locally-trusted development certificates. It creates a local Certificate Authority (CA) and installs it into your system's trust store, allowing browsers to trust certificates generated by mkcert.

### How Gantry Uses mkcert

1. **Local CA Creation**: When you run `gantry setup mkcert`, mkcert creates a local CA and installs it to your system's trust store.

2. **Wildcard Certificate**: Gantry generates a wildcard certificate for `*.test` domains, which covers all your projects:
   - `myapp.test`
   - `postgres.myapp.test`
   - `mailhog.otherproject.test`
   - etc.

3. **Automatic Trust**: Because the CA is installed in your system's trust store, all certificates generated by mkcert are automatically trusted by:
   - Your web browser
   - curl, wget, and other HTTP clients
   - Development tools and APIs

### Setting Up Certificates

Run the complete setup (recommended for first-time users):

```bash
gantry setup all
```

This installs Caddy, mkcert, sets up the CA, and configures DNS.

Or set up certificates individually:

```bash
# Install mkcert
gantry setup mkcert

# Create and install the local CA
gantry cert setup-ca

# Generate certificates for your projects (automatic when you register projects)
```

### Certificate Storage

Certificates are stored in `~/.gantry/certs/`:

```
~/.gantry/certs/
├── wildcard.test.pem      # Wildcard certificate for *.test
├── wildcard.test-key.pem  # Private key for wildcard certificate
└── rootCA.pem             # CA certificate (managed by mkcert)
```

### How Certificates Work

1. **CA Installation**: `mkcert -install` creates a root CA and adds it to your system's certificate store.

2. **Certificate Generation**: When you register projects, Gantry uses mkcert to generate certificates signed by this CA.

3. **Browser Trust**: When you visit `https://myapp.test`, your browser:
   - Receives the certificate
   - Checks if it's signed by a trusted CA
   - Finds the mkcert CA in your system's trust store
   - Trusts the certificate ✅

### Certificate Lifecycle

- **Automatic Generation**: Certificates are generated automatically when needed
- **No Expiration Issues**: mkcert certificates are valid for a long time (typically 825 days)
- **System-Wide Trust**: Once the CA is installed, all mkcert certificates are trusted

### Security Note

⚠️ **Important**: The mkcert CA is only installed on your local machine. Certificates generated by mkcert are **NOT** trusted by other machines or in production. They are strictly for local development.

---

## How to Add Subservices (Adminer, MailHog)

Gantry automatically detects services from your `docker-compose.yml` and creates subdomain routes for them. This section explains how to add common development tools like Adminer (database admin) and MailHog (email testing).

### Understanding Subservice Routing

When Gantry detects services in your `docker-compose.yml`, it automatically creates subdomain routes:

- Main app: `myapp.test` → `localhost:5001`
- PostgreSQL: `postgres.myapp.test` → `localhost:5432`
- MailHog: `mailhog.myapp.test` → `localhost:8025`

### Adding Adminer (Database Administration)

**Adminer** is a lightweight database management tool. To add it to your project:

1. **Add Adminer to your `docker-compose.yml`:**

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5001:5000"
    depends_on:
      - postgres

  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  adminer:
    image: adminer:latest
    ports:
      - "8080:8080"
    depends_on:
      - postgres
```

2. **Register or update your project:**

```bash
# If project is already registered, update it
gantry update myapp

# Or register a new project
gantry register --hostname myapp --path /path/to/project
```

3. **Access Adminer:**

After registration, Adminer will be available at:
- `https://adminer.myapp.test`

To connect to your PostgreSQL database in Adminer:
- **System**: PostgreSQL
- **Server**: `postgres` (Docker service name) or `host.docker.internal` if connecting from outside Docker
- **Username**: `postgres`
- **Password**: `postgres`
- **Database**: `myapp`

### Adding MailHog (Email Testing)

**MailHog** is an email testing tool that captures emails sent by your application. To add it:

1. **Add MailHog to your `docker-compose.yml`:**

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5001:5000"
    environment:
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
    depends_on:
      - mailhog

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web UI port
```

2. **Register or update your project:**

```bash
gantry update myapp
```

3. **Access MailHog:**

MailHog will be available at:
- **Web UI**: `https://mailhog.myapp.test` (port 8025)
- **SMTP**: `mailhog:1025` (from within Docker) or `localhost:1025` (from host)

### Adding Multiple Subservices

You can add multiple subservices to a single project:

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "5001:5000"

  postgres:
    image: postgres:15
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  adminer:
    image: adminer:latest
    ports:
      - "8080:8080"

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"
      - "8025:8025"
```

After running `gantry update myapp`, you'll have:
- `myapp.test` → main app
- `postgres.myapp.test` → PostgreSQL
- `redis.myapp.test` → Redis
- `adminer.myapp.test` → Adminer
- `mailhog.myapp.test` → MailHog web UI

### Service Name Patterns

Gantry recognizes common service patterns and can provide special handling:

- **Databases**: `postgres`, `postgresql`, `mysql`, `mariadb`
- **Caches**: `redis`
- **Mail**: `mailhog`, `mailcatcher`
- **DB Admin**: `adminer`

These patterns are used for future enhancements (e.g., automatic Adminer integration for databases).

### Troubleshooting Subservices

**Issue**: Subservice not accessible via subdomain

**Solutions**:
1. Ensure the service has a `ports` mapping in `docker-compose.yml`
2. Run `gantry update myapp` to refresh service detection
3. Check that Caddy is running: `gantry status`
4. Verify the route exists: `cat ~/.gantry/caddy/Caddyfile`

**Issue**: Port conflict with subservice

**Solutions**:
1. Check which project is using the port: `gantry ports --all`
2. Change the port in `docker-compose.yml`:
   ```yaml
   adminer:
     ports:
       - "8081:8080"  # Changed from 8080:8080
   ```
3. Run `gantry update myapp` to apply changes

---

## Troubleshooting Certificate Trust Issues

If your browser shows certificate warnings or errors when accessing `.test` domains, follow these troubleshooting steps.

### Common Certificate Errors

#### 1. "Your connection is not private" (Chrome/Edge)

**Symptoms**: Browser shows a warning page with "NET::ERR_CERT_AUTHORITY_INVALID"

**Cause**: The mkcert CA is not installed in your system's trust store.

**Solution**:
```bash
# Reinstall the CA
gantry cert setup-ca
```

This runs `mkcert -install`, which adds the CA to your system's certificate store. You may be prompted for your password.

#### 2. "Certificate is not trusted" (Firefox)

**Symptoms**: Firefox shows a security warning

**Cause**: Firefox uses its own certificate store, separate from the system store.

**Solution**:
1. Visit `https://myapp.test` in Firefox
2. Click "Advanced" → "Accept the Risk and Continue"
3. Or manually import the CA certificate:
   ```bash
   # Get the CA certificate path
   mkcert -CAROOT
   # Import ~/.local/share/mkcert/rootCA.pem in Firefox:
   # Settings → Privacy & Security → Certificates → View Certificates → Authorities → Import
   ```

#### 3. Certificate Not Found Errors

**Symptoms**: Caddy errors about missing certificate files

**Cause**: Certificates haven't been generated yet.

**Solution**:
```bash
# Generate certificates for all registered projects
gantry cert generate-all

# Or generate for a specific domain
gantry cert generate myapp.test
```

#### 4. "Certificate has expired"

**Symptoms**: Browser shows certificate expiration error

**Cause**: Rare, but mkcert certificates can expire (typically after 825 days).

**Solution**:
```bash
# Regenerate certificates
gantry cert generate-all
```

### Verifying Certificate Setup

Check if the CA is installed:

```bash
# Check CA status
gantry cert status
```

This shows:
- Whether mkcert is installed
- Whether certutil is available
- CA installation status
- CA certificate path

### Manual CA Installation

If automatic installation fails, install the CA manually:

1. **Get the CA root directory:**
   ```bash
   mkcert -CAROOT
   ```
   This outputs something like: `~/.local/share/mkcert`

2. **Install the CA:**
   ```bash
   mkcert -install
   ```

3. **Verify installation:**
   ```bash
   # Check if rootCA.pem exists
   ls ~/.local/share/mkcert/rootCA.pem
   ```

### System-Specific Issues

#### Linux (Debian/Ubuntu)

If `certutil` is missing:

```bash
sudo apt install libnss3-tools
gantry cert setup-ca
```

#### Linux (Arch/Manjaro)

If `certutil` is missing:

```bash
sudo pacman -S nss
gantry cert setup-ca
```

#### Linux (Fedora/RHEL)

If `certutil` is missing:

```bash
sudo dnf install nss-tools
gantry cert setup-ca
```

### Testing Certificate Trust

Test if certificates are working:

```bash
# Test with curl (should not show certificate errors)
curl -v https://myapp.test

# Test with openssl
openssl s_client -connect myapp.test:443 -servername myapp.test
```

If you see "verify return code: 0 (ok)", the certificate is trusted.

### Resetting Certificate Setup

If you need to start fresh:

1. **Remove the CA from system trust store:**
   ```bash
   # This is system-specific, but generally:
   # Find the CA: mkcert -CAROOT
   # Remove from trust store manually (varies by OS)
   ```

2. **Remove Gantry certificates:**
   ```bash
   rm -rf ~/.gantry/certs/*
   ```

3. **Reinstall:**
   ```bash
   gantry setup all
   ```

### Browser-Specific Trust Issues

#### Chrome/Chromium/Edge

These browsers use the system certificate store. If certificates aren't trusted:
1. Ensure `mkcert -install` completed successfully
2. Restart the browser completely
3. Clear browser cache (optional): `Ctrl+Shift+Delete`

#### Firefox

Firefox maintains its own certificate store:
1. Visit the site and accept the risk temporarily
2. Or import the CA manually (see above)
3. Settings → Privacy & Security → Certificates → View Certificates → Authorities → Import

#### Safari (macOS)

Safari uses the macOS Keychain. Ensure the CA is in the System Keychain:
```bash
# macOS automatically adds it via mkcert -install
# Verify in Keychain Access app: System → Certificates → mkcert
```

### Getting Help

If you're still experiencing certificate issues:

1. **Check Gantry status:**
   ```bash
   gantry status
   ```

2. **Verify mkcert installation:**
   ```bash
   which mkcert
   mkcert -version
   ```

3. **Check certificate files:**
   ```bash
   ls -la ~/.gantry/certs/
   ```

4. **View Caddy logs:**
   ```bash
   # Caddy logs are typically in systemd journal
   journalctl -u caddy -n 50
   ```

5. **Test DNS resolution:**
   ```bash
   gantry dns-test myapp
   ```

---

## Quick Reference

### Setup Commands

```bash
# Complete setup (recommended)
gantry setup all

# Individual setup steps
gantry setup caddy          # Install Caddy
gantry setup mkcert         # Install mkcert
gantry cert setup-ca        # Install CA certificate
gantry dns-setup            # Configure DNS
```

### Certificate Commands

```bash
gantry cert status           # Check certificate status
gantry cert setup-ca        # Install/reinstall CA
gantry cert generate-all    # Generate all certificates
```

### Caddy Commands

```bash
gantry caddy start          # Start Caddy
gantry caddy stop           # Stop Caddy
gantry caddy reload         # Reload configuration
gantry status               # Check all dependencies
```

### Common Workflows

**First-time setup:**
```bash
gantry setup all
gantry register --hostname myapp --path /path/to/project
```

**Adding a subservice:**
1. Add service to `docker-compose.yml`
2. Run `gantry update myapp`
3. Access at `https://servicename.myapp.test`

**Fixing certificate issues:**
```bash
gantry cert setup-ca
gantry caddy reload
```
